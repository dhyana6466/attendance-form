<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance ‚Äì Arise HVAC</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 40px auto;
      background: #add8e6;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
    }
    label {
      margin-top: 12px;
      display: block;
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .record {
      margin-bottom: 10px;
    }
    .mark-btn {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .mark-btn:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arise HVAC Solutions</h1>
    <h2>Attendance Form</h2>

    <form id="attendanceForm">
      <label>ID No:</label>
      <input type="text" id="idno" required />

      <label>Site:</label>
      <input type="text" id="site" required />

      <label>Mark Entry:</label>
      <button type="button" class="mark-btn" onclick="markTime('in')">Mark Entry</button>
      <div class="record">Time: <span id="inTimeDisplay">--:--</span></div>
      <div class="record">Coordinates: <span id="inLocDisplay">--</span></div>

      <label>Mark Exit:</label>
      <button type="button" class="mark-btn" onclick="markTime('out')">Mark Exit</button>
      <div class="record">Time: <span id="outTimeDisplay">--:--</span></div>
      <div class="record">Coordinates: <span id="outLocDisplay">--</span></div>

      <label>Type of Work:</label>
      <select id="workType" required>
        <option value="" disabled selected>Select Work Type</option>
        <option>Installation</option><option>AMC</option><option>Breakdown</option>
        <option>CMC</option><option>Project</option><option>Onetime</option>
      </select>

      <label>Department:</label>
      <select id="dept" required>
        <option value="" disabled selected>Select Department</option>
        <option>H70</option><option>D80</option><option>M10</option>
        <option>L20</option><option>P60</option><option>A200</option><option>A100</option><option>NA</option>
      </select>

      <label>Report Summary:</label>
      <input type="text" id="report" />

      <label>Parts Required:</label>
      <input type="text" id="parts" />

      <button type="submit">Submit</button>
    </form>
  </div>

  <script>
    function formatTime(date) {
      return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    function markTime(type) {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const time = formatTime(new Date());
          const coords = `${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}`;
          document.getElementById(type + "TimeDisplay").textContent = time;
          document.getElementById(type + "LocDisplay").textContent = coords;
          localStorage.setItem(type + "TimeTemp", time);
          localStorage.setItem(type + "LocTemp", coords);
        },
        err => {
          console.error("Geolocation error:", err);
          alert("‚ùå Location Error: " + err.message + "\nPlease allow location access.");
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const record = {
        Date: new Date().toLocaleDateString(),
        ID: document.getElementById('idno').value,
        Site: document.getElementById('site').value,
        InTime: localStorage.getItem("inTimeTemp") || "--",
        InLoc: localStorage.getItem("inLocTemp") || "--",
        OutTime: localStorage.getItem("outTimeTemp") || "--",
        OutLoc: localStorage.getItem("outLocTemp") || "--",
        WorkType: document.getElementById('workType').value,
        Department: document.getElementById('dept').value,
        Report: document.getElementById('report').value,
        Parts: document.getElementById('parts').value
      };

      // üîÑ Submit to local Node.js server
      fetch("https://attendance-server-lxnw.onrender.com/submit", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "x-secret-key": "arise123"
        },
        body: JSON.stringify(record)
      })
      .then(res => res.json())
      .then(data => {
        alert("‚úÖ " + data.message);
        document.getElementById('attendanceForm').reset();
        document.getElementById("inTimeDisplay").textContent = "--:--";
        document.getElementById("outTimeDisplay").textContent = "--:--";
        document.getElementById("inLocDisplay").textContent = "--";
        document.getElementById("outLocDisplay").textContent = "--";
        localStorage.removeItem("inTimeTemp");
        localStorage.removeItem("outTimeTemp");
        localStorage.removeItem("inLocTemp");
        localStorage.removeItem("outLocTemp");
      })
      .catch(err => {
        console.error("Submit Error:", err);
        alert("‚ùå Failed to save data: " + err.message);
      });
    });
  </script>
</body>
</html>
